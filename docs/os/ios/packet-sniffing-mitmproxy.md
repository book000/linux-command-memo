# mitmproxy で iOS Packet-Sniffing する

https://mitmproxy.org

今まで Fiddler を使って HTTPS のパケットスニッフィングをしていたが、以下の不満点があった。

- インストールが面倒。Fiddler Anywhere という新しいアプリケーションが出ていて古い Classic が見つけにくいのと、CertMaker を入れないと HTTPS をキャプチャできない点が気に入らなかった。  
  新しいアプリケーションを出しているということは、古い方のアップデートがまともにされなくなるということだからセキュリティ面の問題もあるし…。
- 設定も面倒。Fiddler 内の色んな設定をいじらないと期待する動作をしないので、中々面倒だった。
- 一部の通信をドロップする。原因特定が出来なかったが、一部のリクエスト / レスポンスで CONNECT しか見えず、通信先ドメインしか拾えないのでそれらの通信を拾えない点が非常に困った。
- リクエスト・レスポンスをファイル保存するなど、カスタムを加える先に JScript.NET で書かなきゃならない点がなんとなく気に入らなかった。

というわけで、数年前から見かけてはいたけど食わず嫌いしていた mitmproxy を試したところいい感じだったのでメモ。

## 注意事項

Fiddler の時と同じなので一部コピペ。

Android でも試そうとしたが、Android 7 からシステム証明書しか信頼できる証明書として使わなくなったらしく、ブラウザしかユーザー証明書を見ないので Android ではルート化せずに Packet Sniffing できないらしい。

https://android-developers.googleblog.com/2016/07/changes-to-trusted-certificate.html

また、中間者攻撃（MITM）を対策している一部のアプリケーション（Twitter など）ではこの方法は使えないので注意。

!!! warning "Warning"
    当然ですが、この記事の内容を使って不正に他者の通信を収集・分析したりしないこと。
    もしそれを企んだところで証明書を端末にインストールしなきゃならないので中々難しそうだけども…。

## Environment

- Windows 10 22H2 (Build 19045.2846)
- iPad Pro 3 (11 inch) / iPadOS 16
- Python 3.11.2
- mitmproxy 9.0.1

## 作業

1. `venv` で Python 仮想環境を作って mitmproxy をインストールする
2. `mitmproxy` コマンドを実行して立ち上げる
3. iOS のプロキシ設定を行う
4. iOS に証明書をインストールする
5. 通信を見れるかを確認
6. `mitmweb` を試してみる
7. スクリプトを用いて全通信をファイルに保存する

### 1. venv で Python 仮想環境を作って mitmproxy をインストールする



### 2. mitmproxy コマンドを実行して立ち上げる



### 3. iOS のプロキシ設定を行う



### 4. iOS に証明書をインストールする



### 5. 通信を見れるかを確認



### 6. mitmweb を試してみる



### 7. スクリプトを用いて全通信をファイルに保存


